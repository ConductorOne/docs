name: Sync Capabilities Matrix

on:
  push:
    branches:
      - main
    paths:
      - 'baton/*.mdx'
      - '!baton/capabilities.mdx'
  workflow_dispatch:
    inputs:
      connector:
        description: 'Connector filename (without .mdx) to check, or "all" for full scan'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-capabilities:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed connector files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.connector }}" ]; then
            if [ "${{ github.event.inputs.connector }}" = "all" ]; then
              echo "files=$(ls baton/*.mdx | grep -v capabilities.mdx | grep -v '^baton/_' | grep -v '^baton/baton-' | tr '\n' ' ')" >> $GITHUB_OUTPUT
            else
              echo "files=baton/${{ github.event.inputs.connector }}.mdx" >> $GITHUB_OUTPUT
            fi
          else
            # Get only changed connector files from the push
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'baton/*.mdx' | grep -v capabilities.mdx | grep -v '^baton/_' | grep -v '^baton/baton-' | tr '\n' ' ')
            echo "files=$CHANGED" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.changed.outputs.files != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run sync script
        if: steps.changed.outputs.files != ''
        id: sync
        run: |
          node .github/scripts/sync-capabilities.js ${{ steps.changed.outputs.files }} > sync-output.json
          echo "has_changes=$(jq -r '.hasChanges' sync-output.json)" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          jq -r '.summary' sync-output.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.changed.outputs.files != '' && steps.sync.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(capabilities): Auto-sync matrix from connector docs'
          title: 'fix(capabilities): Auto-sync matrix from connector docs'
          body: |
            ## Summary

            This PR was automatically generated by the capabilities sync workflow.

            The following mismatches were detected between connector documentation and the capabilities matrix:

            ${{ steps.sync.outputs.summary }}

            ## Test plan
            - [ ] Review each change to verify it matches the connector documentation
            - [ ] Confirm the matrix renders correctly

            ---
            Generated by [sync-capabilities workflow](.github/workflows/sync-capabilities.yml)
          branch: auto/sync-capabilities
          delete-branch: true
          labels: |
            automated
            documentation
